syntax = "proto3";

package server.shop.purchase.v1;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "server/shop/purchase/v1/enums.proto";
import "server/shop/v1/enums.proto";
import "validate/validate.proto";

option go_package = "github.com/stashgg/public-api/gen/proto/server/shop/purchase/v1";

service PurchaseService {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_tag) = {
    name: "Purchase"
    description: "Purchase processing endpoints"
  };
  rpc RegisterPayment(RegisterPaymentRequest) returns (RegisterPaymentResponse) {
    option (google.api.http) = {
      post: "/api/v1/purchase/register"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Register payment intent"
      description: "Step 1: Registers a purchase intent with the game backend. The game backend is expected to reserve inventory for the purchase. IMPORTANT: Always expects HTTP 200 OK response with inline error codes in the body."
      security: [
        {
          security_requirement: {key: "hmac"}
        }
      ]
    };
  }

  rpc ConfirmPayment(ConfirmPaymentRequest) returns (ConfirmPaymentResponse) {
    option (google.api.http) = {
      post: "/api/v1/purchase/confirm"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Confirm payment completion"
      description: "Step 2A: Confirms and completes a pending purchase that was previously registered. IMPORTANT: Expects HTTP error status (3xx, 4xx, 5xx) codes for failed purchases."
      security: [
        {
          security_requirement: {key: "hmac"}
        }
      ]
    };
  }

  rpc CancelPayment(CancelPaymentRequest) returns (CancelPaymentResponse) {
    option (google.api.http) = {
      post: "/api/v1/purchase/cancel"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Cancel pending payment"
      description: "Step 2B: Cancels a pending purchase that was previously registered. IMPORTANT: Always expects HTTP 200 OK response with inline error codes in the body."
      security: [
        {
          security_requirement: {key: "hmac"}
        }
      ]
    };
  }
}

message RegisterPaymentRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Register Payment Request"
      description: "Request to register a purchase intent with the game backend, at which point the game backend is expected to reserve the inventory for the purchase."
      required: [
        "player_id",
        "transaction_id",
        "currency",
        "registrations"
      ]
    }
  };
  string player_id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string.min_len = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The user making the purchase"}
  ];
  string transaction_id = 2 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string.min_len = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Unique transaction identifier for this purchase session"}
  ];
  optional string checkout_link_id = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional checkout link identifier if purchase was made through a checkout link"}];
  server.shop.v1.PaymentEnvironment environment = 12 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Payment environment for the request"}];

  string currency = 4 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string = {
      min_len: 3
      max_len: 3
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Currency code (ISO-4217 code, e.g., 'USD', 'EUR')"}
  ];

  message PurchaseRegistration {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        title: "Purchase Registration"
        description: "Represents a single item registration in a purchase"
        required: [
          "guid",
          "product_id",
          "cents",
          "quantity"
        ]
      }
    };
    string guid = 1 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.uuid = true,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product GUID being purchased (can be auto-generated UUID v5 if not provided in catalog response)"}
    ];
    string product_id = 2 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.min_len = 1,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product SKU being purchased"}
    ];
    uint32 cents = 3 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Price in smallest currency unit (e.g. 999 for $9.99)"}
    ];
    uint32 quantity = 4 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Quantity being purchased (must be positive, no bigint support)"}
    ];
    map<string, string> metadata = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional key-value pairs for additional item metadata"}];
  }
  repeated PurchaseRegistration registrations = 5 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).repeated.min_items = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "List of items to register for purchase"}
  ];

  PurchasePlatform platform = 6 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Platform making the purchase"}];
  string browser = 7 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Browser information for web purchases (e.g., 'Chrome/91.0', 'Firefox/89.0', 'Safari/14.1', 'any')"}];
  string device_id = 8 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Device identifier for tracking and fraud prevention (can be generated client-side)"}];
  PurchaseSource source = 9 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Source of the purchase for analytics"}];
  string ip_address = 10 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Customer IP address for fraud prevention and compliance"}];
  string region = 11 [
    (validate.rules).string = {
      min_len: 2
      max_len: 3
      ignore_empty: true
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Region/country code using ISO-3166-1 alpha-2 code (e.g., 'US', 'CA', 'GB')"}
  ];
}

message RegisterPaymentResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Register Payment Response"
      description: "Expected response format for the RegisterPayment endpoint from the game backend (response body includes status indicating success or failure)."
      required: ["statuses"]
    }
  };
  message OfferStatus {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        title: "Offer Status"
        description: "Represents the status of a registered offer"
        required: ["status"]
      }
    };
    string guid = 1 [
      (validate.rules).string = {
        uuid: true
        ignore_empty: true
      },
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product GUID that was registered (providing this OR product_id is required)"}
    ];
    string product_id = 2 [
      (validate.rules).string = {
        min_len: 1
        ignore_empty: true
      },
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product SKU that was registered (providing this OR guid is required)"}
    ];
    PurchaseRegistrationStatus status = 3 [
      (google.api.field_behavior) = REQUIRED,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Status of the offer registration"}
    ];
    optional string message = 4 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional human-readable status message for debugging"}];
  }
  repeated OfferStatus statuses = 1 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).repeated.min_items = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Status of each registered offer"}
  ];
}

message CancelPaymentRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Cancel Payment Request"
      description: "Request to cancel a pending purchase that was previously registered."
      required: [
        "player_id",
        "transaction_id"
      ]
    }
  };
  string player_id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string.min_len = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The user canceling the purchase"}
  ];
  string transaction_id = 2 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string.min_len = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Transaction identifier to cancel"}
  ];
  optional string checkout_link_id = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional checkout link identifier if purchase was made through a checkout link"}];
  server.shop.v1.PaymentEnvironment environment = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Payment environment for the request"}];

  message CanceledItem {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        title: "Canceled Item"
        description: "Represents a single item in the canceled purchase"
        required: [
          "guid",
          "product_id",
          "quantity",
          "cents"
        ]
      }
    };
    string guid = 1 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.uuid = true,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product GUID being canceled (can be auto-generated UUID v5 if not provided in catalog response)"}
    ];
    string product_id = 2 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.min_len = 1,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product SKU being canceled"}
    ];
    uint32 quantity = 3 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Quantity canceled (must be positive)"}
    ];
    uint32 cents = 4 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Price per item in smallest currency unit (e.g. 999 for $9.99)"}
    ];
    map<string, string> metadata = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional key-value pairs for additional item metadata"}];
  }
  repeated CanceledItem items = 4 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).repeated.min_items = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "List of items in this canceled purchase"}
  ];
}

message CancelPaymentResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Cancel Payment Response"
      description: "Expected response format for the CancelPayment endpoint from the game backend (response body includes status indicating success or failure)."
    }
  };
  PurchaseCancellationStatus status = 1 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Status of the cancellation"}];
  optional string message = 2 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional human-readable status message"}];
}

message ConfirmPaymentRequest {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Confirm Payment Request"
      description: "Request to confirm and complete a pending purchase that was previously registered."
      required: [
        "player_id",
        "transaction_id",
        "currency",
        "tax",
        "total",
        "time_millis",
        "items"
      ]
    }
  };
  string player_id = 1 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string.min_len = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The user confirming the purchase"}
  ];
  string transaction_id = 2 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string.min_len = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Transaction identifier to confirm"}
  ];
  optional string checkout_link_id = 3 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional checkout link identifier if purchase was made through a checkout link"}];
  server.shop.v1.PaymentEnvironment environment = 21 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Payment environment for the request"}];

  string currency = 4 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).string = {
      min_len: 3
      max_len: 3
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Currency code (ISO-4217 code, e.g., 'USD', 'EUR')"}
  ];
  uint32 tax = 5 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).uint32.gte = 0,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Tax amount in smallest currency unit (e.g. 99 for $0.99, can be 0)"}
  ];
  uint32 total = 6 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).uint32.gt = 0,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Total purchase amount in smallest currency unit including tax (e.g. 1098 for $10.98)"}
  ];
  int64 time_millis = 7 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).int64.gt = 0,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Timestamp when the purchase was completed (milliseconds since Unix epoch)"}
  ];
  PaymentMethodType payment_method_type = 20 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Payment method used for this purchase (e.g., card, Apple Pay, Google Pay)"}];

  message PurchasedItem {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        title: "Purchased Item"
        description: "Represents a single item in the completed purchase"
        required: [
          "guid",
          "product_id",
          "quantity",
          "cents"
        ]
      }
    };
    string guid = 1 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.uuid = true,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product GUID being purchased (can be auto-generated UUID v5 if not provided in catalog response)"}
    ];
    string product_id = 2 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.min_len = 1,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product SKU being purchased"}
    ];
    uint32 quantity = 3 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Quantity purchased (must be positive)"}
    ];
    uint32 cents = 4 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Price per item in smallest currency unit (e.g. 999 for $9.99)"}
    ];
    map<string, string> metadata = 5 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional key-value pairs for additional item metadata"}];
  }
  repeated PurchasedItem items = 8 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).repeated.min_items = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "List of items in this purchase"}
  ];

  PurchasePlatform platform = 9 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Platform making the purchase"}];
  string browser = 10 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Browser information for web purchases (e.g., 'Chrome/91.0', 'Firefox/89.0', 'Safari/14.1', 'any')"}];
  string device_id = 11 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Device identifier for tracking and fraud prevention (can be generated client-side)"}];
  PurchaseSource source = 12 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Source of the purchase for analytics"}];
  string ip_address = 13 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Customer IP address for fraud prevention and compliance"}];
  string region = 14 [
    (validate.rules).string = {
      min_len: 2
      max_len: 3
      ignore_empty: true
    },
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Region/country code using ISO-3166-1 alpha-2 code (e.g., 'US', 'CA', 'GB')"}
  ];
  string user_email = 22 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Customer email for the purchase"}];
  optional bool email_marketing_opt_in = 15 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional flag indicating if customer opted in to email marketing"}];

  message BonusItem {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        title: "Bonus Item"
        description: "Represents a bonus item to be granted with the purchase"
        required: [
          "id",
          "quantity"
        ]
      }
    };
    string id = 1 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).string.min_len = 1,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Unique identifier for the bonus item"}
    ];
    uint32 quantity = 2 [
      (google.api.field_behavior) = REQUIRED,
      (validate.rules).uint32.gt = 0,
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Quantity of the bonus item to grant (must be positive)"}
    ];
  }
  repeated BonusItem bonus_items = 19 [(grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Optional list of bonus items to be granted with the purchase"}];
}

message ConfirmPaymentResponse {
  option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
    json_schema: {
      title: "Confirm Payment Response"
      description: "Expected response format for the ConfirmPayment endpoint from the game backend (presence of results in response body indicates success)."
      required: ["results"]
    }
  };
  message ConfirmPaymentResult {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_schema) = {
      json_schema: {
        title: "Confirm Payment Result"
        description: "Represents the result of a confirmed purchase"
      }
    };
    string guid = 1 [
      (validate.rules).string = {
        uuid: true
        ignore_empty: true
      },
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product GUID that was registered (providing this OR product_id is required)"}
    ];
    string product_id = 2 [
      (validate.rules).string = {
        min_len: 1
        ignore_empty: true
      },
      (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "The offer/product SKU that was registered (providing this OR guid is required)"}
    ];
  }
  repeated ConfirmPaymentResult results = 1 [
    (google.api.field_behavior) = REQUIRED,
    (validate.rules).repeated.min_items = 1,
    (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_field) = {description: "Results of the confirmed purchases"}
  ];
}
